<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js Texture Exploration</title>
    <style>
        body {
            margin: 0;
        }

        canvas {
            display: block;
        }
    </style>
</head>

<body>
    <!-- Import Map for Three.js and Addons -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three/examples/jsm/",
                "three/examples/": "https://cdn.jsdelivr.net/npm/three/examples/"
            }
        }
    </script>

    <script type="module">
        // Importing Three.js and Addons
        import * as THREE from 'three';
        import Stats from 'three/addons/libs/stats.module.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { clone } from 'three/examples/jsm/utils/SkeletonUtils.js';

        // Initialize Cache
        THREE.Cache.enabled = true;

        // Global variables
        let container, stats, rat, axe;
        let naruto, mixer, mixerFire, clock, action, actionFire;
        let sasuke_obj, naruto_obj, animations, fire_animation, fire;
        let narutoObjs = [];
        let mixers = [];
        let naruto_obj_clone;

        // Initialize Scene and Camera
        container = document.createElement('div');
        document.body.appendChild(container);

        const scene = new THREE.Scene();

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 0.1);

        // Initialize Renderer
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Add Lighting
        const light = new THREE.AmbientLight(0xffffff);
        scene.add(light);

        // Loaders
        const cubeTextureLoader = new THREE.CubeTextureLoader();
        const loaderGtf = new GLTFLoader();
        clock = new THREE.Clock();

        // Audio Setup
        const listener = new THREE.AudioListener();
        camera.add(listener);

        const sound = new THREE.Audio(listener);
        const jutsuSound = new THREE.Audio(listener);
        const cloneSound = new THREE.Audio(listener);

        const audioLoader = new THREE.AudioLoader();
        audioLoader.load('audios/Kage_Bunshin_no_Jutsu.mp3', function(buffer) {
            sound.setBuffer(buffer);
            sound.setVolume(0.5);
        });

        const audioLoaderJutsu = new THREE.AudioLoader();
        audioLoaderJutsu.load('audios/fireball_sound.mp3', function(buffer) {
            jutsuSound.setBuffer(buffer);
            jutsuSound.setVolume(0.5);
        });

        const audioLoaderClone = new THREE.AudioLoader();
        audioLoaderClone.load('audios/naruto_clone_sound.mp3', function(buffer) {
            cloneSound.setBuffer(buffer);
            cloneSound.setVolume(0.5);
        });

        // Load Models
        loaderGtf.load('models/naruto__sasuke/scene.gltf', function(gltf) {
            naruto = gltf.scene;
            animations = gltf.animations;

            sasuke_obj = gltf.scene.getObjectByName('Object_5');
            sasuke_obj.position.set(-10, 15, -7);

            naruto_obj = gltf.scene.getObjectByName('Object_582');
            naruto_obj.position.set(10, 15, -7);

            scene.add(naruto);

            mixer = new THREE.AnimationMixer(naruto);
            action = mixer.clipAction(animations[4]);
            mixers.push(mixer);
        }, undefined, function(error) {
            console.error(error);
        });

        loaderGtf.load('models/sala_examen_chunnin/scene.gltf', function(gltf) {
            const scale = 10;
            const sala_examen_chunnin = gltf.scene;
            sala_examen_chunnin.scale.set(scale, scale, scale);
            sala_examen_chunnin.position.set(10, -90, -460);
            scene.add(sala_examen_chunnin);
        }, undefined, function(error) {
            console.error(error);
        });

        loaderGtf.load('models/fire_animation/scene.gltf', function(gltf) {
            fire = gltf.scene;
            fire_animation = gltf.animations;
            fire.position.set(-7, -3.5, -15);
            fire.rotation.z = 8;
            mixerFire = new THREE.AnimationMixer(fire);
        }, undefined, function(error) {
            console.error(error);
        });

        // Orbit Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.minPolarAngle = Math.PI / 4;
        controls.maxPolarAngle = Math.PI / 1.5;

        // Stats
        stats = new Stats();
        container.appendChild(stats.dom);

        // Event Listeners
        window.addEventListener('keydown', (event) => {
            if (event.code === 'ControlLeft') {
                scene.remove(fire);
                action = mixer.clipAction(animations[2]);
                action.fadeIn(6);
                action.play();
                actionFire = mixerFire.clipAction(fire_animation[0]);

                while (sasuke_obj.rotation.z > -5) sasuke_obj.rotation.z -= 0.0005;

                jutsuSound.play();
            }

            if (event.code === 'ControlRight') {
                naruto_obj_clone = clone(naruto_obj);
                naruto_obj_clone.position.set(Math.floor(Math.random() * 10), -7, Math.floor(Math.random() * (-10 - 15)));
                naruto_obj_clone.rotation.set(4.6, 0, 4.5);
                narutoObjs.push(naruto_obj_clone);

                action = mixer.clipAction(animations[4]);
                action.play();

                const newMixer = new THREE.AnimationMixer(naruto_obj_clone);
                const newAction = newMixer.clipAction(animations[4]);
                newAction.play();
                mixers.push(newMixer);

                sound.play();
            }

            if (event.code === 'Space') {
                mixer.stopAllAction();
                scene.remove(fire);
                sasuke_obj.rotation.z = 0;
                naruto_obj.rotation.z = 0;
                cloneSound.play();

                narutoObjs.forEach(narutoObj => {
                    scene.remove(narutoObj);
                });
            }
        });

        // Animation Loop
        function animate() {
            if (sound.isPlaying) {
                if (naruto_obj.rotation.z > -1.78) naruto_obj.rotation.z -= 0.002;
            }

            sound.onEnded = function() {
                this.isPlaying = false;
                scene.add(naruto_obj_clone);
                return THREE.Audio.prototype.onEnded;
            };

            jutsuSound.onEnded = function() {
                this.isPlaying = false;
                scene.add(fire);

                actionFire.fadeIn(3);
                actionFire.play();

                return THREE.Audio.prototype.onEnded;
            };

            const delta = clock.getDelta();
            mixers.forEach(mixer => mixer.update(delta));

            if (mixerFire) mixerFire.update(clock.getDelta() + 0.01);

            requestAnimationFrame(animate);
            renderer.render(scene, camera);
            stats.update();
        }

        animate();
    </script>
</body>

</html>
